user  www-data www-data;
# This number should be, at maximum, the number of CPU cores on your system. 
worker_processes auto;
worker_cpu_affinity auto;
worker_rlimit_nofile 65535;

thread_pool default threads=64 max_queue=65536;
pcre_jit on;

pid        /var/run/nginx.pid;

events {
    worker_connections 65535;
    worker_aio_requests 128;
    multi_accept on;    
    accept_mutex on;    
    use epoll;

}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    #long time
    check_shm_size 5M;
    # Allow the server to close the connection after a client stops responding. 
    reset_timedout_connection on;
    client_header_timeout 300;
    # Send the client a "request timed out" if the body is not loaded by this time.
    client_body_timeout 300;
    # If the client stops reading data, free up the stale client connection after this much time.
    send_timeout 300;
    # Timeout for keep-alive connections. Server will close connections after this time.
    keepalive_timeout 600;
    # Number of requests a client can make over the keep-alive connection.
    keepalive_requests 600;

    client_body_buffer_size 128k;
    client_max_body_size 50m;
    proxy_read_timeout 180s;
 
    # Compression.
    brotli on;
    brotli_comp_level 3;
    gzip on;
    gzip_comp_level   3;
    include /etc/nginx/extras/gzipbrotli.conf;

    # Sendfile copies data between one FD and other from within the kernel.
    sendfile on; 
    sendfile_max_chunk 1m;
    # Don't buffer data-sends (disable Nagle algorithm).
    tcp_nodelay on; 
    # Causes nginx to attempt to send its HTTP response head in one packet,  instead of using partial frames.
    tcp_nopush on;

    # Hide web server information
    server_tokens off;
    server_info off;
    server_tag off;

    charset utf-8;

    server_name_in_redirect off;
    port_in_redirect off;
    server_names_hash_bucket_size 128;
    types_hash_max_size 2048;
    etag off;
    ignore_invalid_headers on;

    large_client_header_buffers 8 64k;
    client_header_buffer_size 64k;

    proxy_buffering off;

    # redirect server error pages to the static page
    # definir em server block
    #error_page 404             /no-route;
    #error_page 500 502 503 504 /erros;

    #performance
    directio 8m;
	aio threads=default;
	aio_write on;

    #tengine tenativa de conexao upstream
	proxy_upstream_tries 3;
	fastcgi_upstream_tries 3;


    #heades adicionais
    more_clear_headers server;
	more_set_headers "Server: NG-TG Redati";

    #keycdn real ip
    set_real_ip_from 177.54.152.0/21;
	set_real_ip_from 185.172.148.0/24;
	set_real_ip_from 185.172.149.0/24;
	set_real_ip_from 185.172.150.0/24;
	set_real_ip_from 185.172.151.0/24;
	set_real_ip_from 68.70.192.0/24;
	set_real_ip_from 68.70.196.0/24;
	set_real_ip_from 68.70.197.0/24;
	set_real_ip_from 68.70.198.0/24;
	set_real_ip_from 68.70.199.0/24;
	set_real_ip_from 68.70.200.0/24;
	set_real_ip_from 68.70.204.0/24;
	set_real_ip_from 68.70.205.0/24;
	set_real_ip_from 68.70.207.0/24;	

	#cloudflare real ip
	set_real_ip_from 103.21.244.0/22;
	set_real_ip_from 103.22.200.0/22;
	set_real_ip_from 103.31.4.0/22;
	set_real_ip_from 104.16.0.0/12;
	set_real_ip_from 108.162.192.0/18;
	set_real_ip_from 131.0.72.0/22;
	set_real_ip_from 141.101.64.0/18;
	set_real_ip_from 162.158.0.0/15;
	set_real_ip_from 172.64.0.0/13;
	set_real_ip_from 173.245.48.0/20;
	set_real_ip_from 188.114.96.0/20;
	set_real_ip_from 190.93.240.0/20;
	set_real_ip_from 197.234.240.0/22;
	set_real_ip_from 198.41.128.0/17;
	set_real_ip_from 2400:cb00::/32;
	set_real_ip_from 2606:4700::/32;
	set_real_ip_from 2803:f800::/32;
	set_real_ip_from 2405:b500::/32;
	set_real_ip_from 2405:8100::/32;
	set_real_ip_from 2c0f:f248::/32;
	set_real_ip_from 2a06:98c0::/29;

    #varnish real ip
	set_real_ip_from 127.0.0.1;
    real_ip_header X-Forwarded-For;

    #Mobile Detect = KeyCdn > Image Optimization
    map $http_user_agent $ua_device {
		default "desktop";
		"~*(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge\ |maemo|midp|mmp|mobile.+firefox|netfront|opera\ m(ob|in)i|palm(\ os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows\ ce|xda|xiino/i" "mobile";
	}

    #fix soliciação sem x_fowarded_for
    map $http_x_forwarded_for $realip {
        ~^(\d+\.\d+\.\d+\.\d+) $1;
        default $remote_addr;
    }

    #geoip2
    geoip2_proxy_recursive on;
	geoip2 /etc/nginx/extras/geoip/GeoLite2-ASN.mmdb {
        auto_reload 60m;        
        $geoip2_data_org source=$realip autonomous_system_organization;
        $geoip2_data_asn source=$realip autonomous_system_number;
	}
	geoip2 /etc/nginx/extras/geoip/GeoLite2-Country.mmdb {
		auto_reload 60m;
	    $geoip2_data_country_code default=US source=$realip country iso_code;
    }

    map $request_filename $logable {
		~\.js$ 0;
		~\.css$ 0;
        ~\.html$ 0;
        ~\.png$ 0;
        ~\.jpg$ 0;
        ~\.jpeg$ 0;
        ~\.svg$ 0;
        ~\.gif$ 0;
        ~\.ico$ 0;
        ~\.woff$ 0;
        ~\.woff2$ 0;
        ~\.otf$ 0;
        ~\.map$ 0;
        ~\.json$ 0;
		default 1;
	}

    map $host $hostp {
		default 0;
        m2.com 1;
        www.m2.com 1;
        cdn.m2.com 1;
		localhost 1;
		127.0.0.1 1;
	}

    #upstreans
    upstream app {
        server app:9000;
    }


    log_format json_combined escape=json
        '{'
            '"http.version":"$server_protocol",'
            '"http.status_code":$status,'
            '"http.method":"$request_method",'
            '"http.referer":"$http_referer",'
            '"http.useragent":"$http_user_agent",'
	        '"http.url":"$request_uri",'
            '"date":"$time_local",'
            '"remote_addr":"$remote_addr",'
            '"remote_user":"$remote_user",'
            '"body_bytes_sent":"$body_bytes_sent",'
            '"duration":$request_time,'
            '"response_content_type":"$sent_http_content_type",'
            '"X-Forwarded-For":"$http_x_forwarded_for",'
            '"network.client.geoip.country.iso_code":"$geoip2_data_country_code",'
	        '"ssl_protocol":"$ssl_protocol",'
	        '"http.host":"$http_host",'
            '"asn":"$geoip2_data_asn",'
            '"asn_org":"$geoip2_data_org",'
            '"realip":"$realip",'
         '}';
    
    include /etc/nginx/extras/secure/naxsi_core.rules;
	include /etc/nginx/extras/secure/seguro_ag;
	include /etc/nginx/extras/secure/seguro_asn;
	include /etc/nginx/extras/secure/doxi-rules/*.rules;

    include /etc/nginx/sites-enabled/*.conf;
}